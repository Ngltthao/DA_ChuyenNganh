{% extends 'home.html' %} {% block title %}Sản phẩm mới | The Goat Shop{% endblock%}
{% block content %}

<style>

.collection_section{ width: 100%; float: left; padding-bottom: 0px; }
.new_text{
	width: 100%;
	float: left;
	font-size: 24pt;
	color: #0c0116;
}

.consectetur_text{
	width: 100%;
	float: left;
	font-size: 14pt;
	color: #0c0116;
	font-weight: 400;
	margin-left: 0px;
    padding-bottom: 30px;
}

.collection_section_2{
	width: 100%;
	float: left;
}

.about-img {
    width: 100%;
    float: left;
    background-color: #ffffff;
    height: auto;
    margin-left: 64px;
    box-shadow: 0px 0px 10px 0px;
    position: relative;
    z-index: 1;
}
.new_bt{
	width: 18%;
	float: left;
	background-color: #000;
	font-size: 14pt;
	text-align: center;
	color: #ffffff;
	height: 50px;
	margin-left: -60px;
	border-radius: 0;
}

.shoes-img{
	width: 100%;
	float: left;
	text-align: center;
	padding-top: 40px;
	padding-bottom: 40px;
	margin: 0px;
}

.sport_text {
    width: 50%;
    text-align: center;
    padding-top: 30px;
    font-size: 16pt;
    color: #0c0116;
    border-bottom: 1px solid#000;
    margin: 0 auto;
}
.dolar_text{
	width: 100%;
	float: left;
	text-align:center;
	color: #000;
	font-size: 20pt;
}
.star_icon{ width: 25%; margin: 0 auto; text-align: center; }
.star_icon ul{ margin: 0px; padding: 0px;} 
.star_icon li{ float:left; padding-right:10px; padding-bottom: 25px;}

.about-img2{
	width: 100%;
	float: left;
	background-image: url(../static/images/about-img2.png) !important;
	height: auto;
	box-shadow: 0px 0px 10px 0px;
	margin-left: -50px;
    margin-top: 74px;
}


.shoes_img{ width: 100%; float: left; padding-top: 30px; }

.shoes-img2{
	width: 100%;
	float: left;
	text-align: center;
	padding-top: 100px;
	padding-bottom: 40px;
	margin: 0px
}

.seemore_bt{
	width: 32%;
	height: 50px;
	color: #ffffff;
	background-color: #ff4e5b;
	color: #ffffff;
	font-size: 16pt;	
	margin-top: 35px;
    margin-bottom: 90px;
}

.img1 {
    max-width: 100%;
    height: 260px;
    transition: transform 0.3s ease-in-out; /* Hiệu ứng mượt */
}

.img1:hover {
    transform: scale(1.8); /* Phóng to ảnh khi hover */
}


@media (min-width: 768px) {
    .col-md-6 {
        -ms-flex: 0 0 50%;
        flex: 0 0 50%;
        max-width: 50%;
    }
}

a.nav-item.nav-link.bestsales {
    color: #00ffd4;
    font-weight: bolder;
    text-decoration: underline !important;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -55%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
}

.modal {
    display: none;
    position: fixed;
    margin: 6% auto;
    width: 90%;
    max-width: 50%;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    text-align: center;
}

.close {
    float: right;
    font-size: 20px;
    cursor: pointer;
    color: #555;
}
.close:hover {
    color: #f12a47;
}

/* Bố cục sản phẩm */
.product-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 10px 0;
}

.product-option {
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    background: #f9f9f9;
    transition: transform 0.2s;
}
.product-option:hover {
    transform: scale(1.05);
}

/* Ảnh sản phẩm */
.modal-img {
    width: 100%;
    max-width: 300px;
    height: auto;
    border-radius: 5px;
}

/* Chọn số lượng */
.quantity-selection {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
}

.quantity-input {
    width: 75px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 5px;
    font-size: 20px;
}

/* Nút bấm */
button {
    padding: 10px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    transition: background 0.2s;
}
button:hover {
    opacity: 0.8;
}

.decrease, .increase {
    width: 35px; /* Tăng kích thước */
    height: 35px;
    background: #ddd;
    border-radius: 50%;
    font-size: 18px;
    display: flex; /* Căn giữa dấu + và - */
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.decrease:hover, .increase:hover {
    background: #bbb; /* Màu hover */
}

.decrease:active, .increase:active {
    transform: scale(0.9); /* Hiệu ứng khi bấm */
}


/* Nút xác nhận */
#confirmPurchase {
    background: #f12a47;
    color: white;
    font-weight: bold;
    width: 70%;
    font-size: 20px;
    margin: auto;
    border-radius: 15px;
}

/* Nút hủy */
#cancelPurchase {
    background: #ccc;
    color: black;
    font-weight: bold;
    width: 100%;
    width: 70%;
    font-size: 20px;
    margin: 10px auto;
    border-radius: 15px;
}

/* Responsive */
@media (max-width: 768px) {
    .modal {
        width: 95%;
        max-width: 90%;
    }
    .product-options {
        grid-template-columns: repeat(1, 1fr);
    }
}

.product-options {
    display: flex;
    justify-content: space-around;
    margin: 10px 0;
}
.product-option {
    text-align: center;
    width: 50%;
}

.quantity-selection {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin: 10px 0;
}
.quantity-input {
    width: 60px;
    text-align: center;
}
button {
    padding: 10px;
    border: none;
    cursor: pointer;
}

.row {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: nowrap;
    margin-right: -15px;
    margin-left: -15px;
    flex-direction: row;
}

</style>

	<!-- new collection section start -->
    <div class="collection_text" style="margin-top: 1%; padding: 20px 0;">Best - Sales</div>
    <div class="layout_padding collection_section" style="background-color: aliceblue;">
    	<div class="container">
    	    <h1 class="new_text"><strong>✨ Săn deal sốc – Mua sắm thả ga! ✨</strong></h1>
    	    <p class="consectetur_text">Với thiết kế tinh tế và chất liệu cao cấp, những sản phẩm này không chỉ mang đến sự thoải mái mà còn giúp bạn tỏa sáng với phong cách ấn tượng. Đẹp mắt, bền bỉ, tiện dụng – tất cả đều có mức giá ưu đãi chưa từng có. Nhanh tay sở hữu ngay hôm nay!</p>
			<div class="collection_section_2">
				<div class="row one">
					{% for product in top_discount_products %}
						{% if forloop.first %}
							<!-- Sản phẩm có giảm giá cao nhất -->
							<div class="col-md-6">
								<div class="about-img">
									<button class="new_bt">New</button>
									<div class="shoes-img">
										<img class="img1" src="{{ product.hinh_anh }}" alt="{{ product.ten_san_pham }}">
									</div>
									<p class="sport_text">{{ product.ten_san_pham }}</p>
									<div class="dolar_text">
										<span class="original-price">${{ product.gia }}</span>
										<strong style="color: #f12a47;">${{ product.get_final_price }}</strong>
									</div>
								</div>
								<button class="seemore_bt">Mua ngay</button>
							</div>
						{% else %}
							<!-- Sản phẩm có giảm giá lớn thứ hai -->
							<div class="col-md-6">
								<div class="about-img2">
									<div class="shoes-img2">
										<img class="img1" src="{{ product.hinh_anh }}" alt="{{ product.ten_san_pham }}">
									</div>
									<p class="sport_text">{{ product.ten_san_pham }}</p>
									<div class="dolar_text">
										<span class="original-price">${{ product.gia }}</span>
										<strong style="color: #f12a47;">${{ product.get_final_price }}</strong>
									</div>
								</div>
							</div>
						{% endif %}
					{% endfor %}
				</div>
			</div>			
    	</div>
    </div><div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="font-size: 25px; font-weight: bolder;">Chọn sản phẩm và số lượng</h2>
    
            <div class="product-options">
                {% for product in top_discount_products %}
                <div class="product-option">
                    <label>
                        <input type="checkbox" class="product-checkbox" value="{{ product.id }}" data-name="{{ product.ten_san_pham }}">
                        <img src="{{ product.hinh_anh }}" alt="{{ product.ten_san_pham }}" class="modal-img">
                        <p style="font-size: 25px;font-weight: 500;">{{ product.ten_san_pham }}</p>
                        <p><strong style="color: #f12a47; font-size: 25px;">${{ product.get_final_price }}</strong></p>
                    </label>
    
                    <div class="quantity-selection">
                        <button class="decrease" disabled>-</button>
                        <input type="number" class="quantity-input" value="1" min="1">
                        <button class="increase">+</button>
                    </div>
                </div>
                {% endfor %}
            </div>
    
            <button id="confirmPurchase">Xác nhận</button>
            <button id="cancelPurchase">Hủy</button>
        </div>
    </div>
    

<script>
document.addEventListener("DOMContentLoaded", function() {
    let modal = document.getElementById("purchaseModal");
    let closeBtn = document.querySelector(".close");
    let confirmBtn = document.getElementById("confirmPurchase");

    // Mở modal khi nhấn "Mua ngay"
    document.querySelectorAll(".seemore_bt").forEach(button => {
        button.addEventListener("click", function() {
            modal.style.display = "block";
        });
    });

    // Đóng modal khi nhấn nút đóng hoặc hủy
    closeBtn.onclick = function() {
        modal.style.display = "none";
    };
    document.getElementById("cancelPurchase").onclick = function() {
        modal.style.display = "none";
    };

    // Xác nhận sản phẩm đã chọn
    confirmBtn.addEventListener("click", function() {
        let selectedProducts = [];
        let token = localStorage.getItem("access_token"); // Lấy token từ localStorage

        if (!token) {
            alert("⚠️ Bạn chưa đăng nhập! Vui lòng đăng nhập để tiếp tục.");
            return;
        }

        document.querySelectorAll(".product-checkbox:checked").forEach(checkbox => {
            let productId = checkbox.value;
            let quantity = checkbox.closest(".product-option").querySelector(".quantity-input").value;

            selectedProducts.push({ product_id: productId, quantity: parseInt(quantity) });
        });

        if (selectedProducts.length === 0) {
            alert("⚠️ Vui lòng chọn ít nhất một sản phẩm!");
            return;
        }

        // Gửi dữ liệu đến Django API (hỗ trợ JWT)
        fetch("/api/cart/add/", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ products: selectedProducts })
})
.then(response => response.json().then(data => ({ status: response.status, body: data }))) // ✅ Log cả status code và response
.then(({ status, body }) => {
    console.log("📤 Response từ server:", status, body);

    if (status === 400) {
        alert("⚠️ Lỗi 400: " + (body.error || "Yêu cầu không hợp lệ."));
    } else if (status === 401) {
        alert("⚠️ Bạn chưa đăng nhập!");
        window.location.href = "/login";
    } else if (body.success) {
        alert("🛒 Sản phẩm đã được thêm vào giỏ hàng!");
        modal.style.display = "none";
    } else {
        alert("⚠️ Đã xảy ra lỗi: " + (body.message || "Lỗi không xác định."));
    }
})
.catch(error => console.error("❌ Lỗi:", error));

    });
});
	</script>
	
{% endblock %}